<!DOCTYPE html>

<html lang="zh-Hans">
    <head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <!--
        © SukkaW
        GitHub: https://github.com/SukkaW/hexo-theme-suka
        Version: 1.3.3
    -->
    <script>
window.lsVersion = "1.3.3",
window.oldVersion = [
    
        
            "0.2.0","0.0.1","0.1.0","1.0.0","1.0.1","1.1.0","1.1.1","1.2.0","1.3.0","1.3.2"
        
    
]
</script>

    <!-- ### DNS Prefetch ### -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
<!-- busuanzi -->

    <link rel="dns-prefetch" href="//busuanzi.ibruce.info">


<!-- comment -->







<!-- analytics -->








    <!-- ### Preload ### -->
    
    <!-- Busuanzi -->
    
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" as="script">







    <!-- ### Meta & Title & Info ### -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge, chrome=1">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<!-- Title -->
<title>ARIES | Aione&#39;s blog</title>

<!-- favicon -->
<!-- Favicons -->

    <link rel="icon" type="image/ico" href="/img/new/favicon.ico">


    <link rel="apple-touch-icon" sizes="180x180" href="/img/new/apple-icon-180x180.png">


    <link rel="icon" type="image/png" sizes="192x192" href="/img/new/android-icon-192x192.png">


    <link rel="icon" type="image/png" sizes="32x32" href="/img/new/favicon-32x32.png">


    <link rel="icon" type="image/png" sizes="16x16" href="/img/new/favicon-16x16.png">


<!-- Android Chrome Color -->



<meta name="format-detection" content="telephone=no">

<!-- Description -->
<meta name="description" content="大概是 ARIES 论文的阅读笔记。
A...">

<!-- Keywords -->
<meta name="keywords" content=", database, transaction, aries">

<!-- Disable Fucking Bloody Baidu Tranformation -->
<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

    <!-- ### Import File ### -->
    
        <!-- spectre.css -->

    <link rel="stylesheet" href="/lib/spectre/spectre.min.css">


<style>
    body {
        background-color: #f8f9fa;
    }

    a, a:visited {
        color: #0070ff;
    }

    a:active, a:focus, a:hover {
        color: #0070ff;
        opacity: .75;
    }

    #post-content a,
    #post-content a:hover,
    #post-content a:focus,
    #post-content a:visited {
        color: #005eb9;
        opacity: 1;
    }

    .post-entry .card-body a {
        color: #0070ff;
    }

    .avatar {
        background: #444;
    }

    .navbar-link,
    .navbar-link:visited,
    .timeline .timeline-item .timeline-icon.icon-lg {
        color: #0070ff;
    }

    .navbar-link:hover {
        color: #0070ff;
        opacity: .8;
    }

    #search-input .btn,
    #disqus_click_btn,
    #disqus-switch-to-direct,
    #disqus-loadmore-button {
        background: #727e96;
        border-color: #727e96;
        color: #fff;
    }

    #post-toc a.post-toc-link,
    #post-toc a.post-toc-link:visited,
    .share-menu.menu .menu-item>a {
        color: #727e96;
    }

    .share-menu.menu .menu-item>a:hover,
    .share-menu.menu .menu-item>a:focus,
    .share-menu.menu .menu-item>a:visited {
        color: #50596c;
        background: #f8f9fa;
        opacity: .85;
    }
</style>

<!-- style.css -->

    <link rel="stylesheet" href="/css/style.min.css">









    <!-- Prettify Theme -->
    
    
        <link rel="stylesheet" href="/css/highlight/github.min.css">
    



    

    <!-- ### Site Verification ### -->
    


    <!-- ### RSS ### -->
    

    <!-- ### WebApp ### -->
    <meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="Aione&#39;s blog">
<meta name="msapplication-starturl" content="https://aione.space">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Aione&#39;s blog">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Manifest Import -->

<!-- Open Search -->


    <!-- ### The Open Graph & Twitter Card Protocol ### -->
    <meta property="og:title" content="ARIES | Aione&#39;s blog">
<meta property="og:site_name" content="Aione&#39;s blog">

<meta property="og:locale" content="zh-Hans">

<meta property="og:url" content="https://aione.space/2020/05/26/aries/">
<meta property="og:image" content="https://aione.space/img/new/android-icon-192x192.png">

<meta property="og:description" content="大概是 ARIES 论文的阅读笔记。
A...">

<meta name="twitter:card" content="summary">


    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2020-05-26T10:48:14.000Z">
    <meta property="article:modified_time" content="2020-05-26T10:48:14.000Z">
    <meta property="article:author" content="Aione">
    <meta property="og:article:tag" content=", database, transaction, aries"> 





    <!-- ### Analytics ### -->
    








    <!-- ### Canonical link ### -->
    <link rel="canonical" href="https://aione.space/2020/05/26/aries/">

    <!-- ### Structured Data ### -->
    



<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "url": "https://aione.space/2020/05/26/aries/",
    "@type": "BlogPosting",
    "logo": "https://aione.space/img/new/android-icon-192x192.png",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://aione.space/2020/05/26/aries/"
    },
    "headline": "ARIES | Aione&#39;s blog",
    
    "image": {
        "@type": "ImageObject",
        "url": "https://aione.space/img/new/android-icon-192x192.png"
    },
    
    "datePublished": "2020-05-26T10:48:14.000Z",
    "dateModified": "2020-05-28T12:18:55.597Z",
    "author": {
        "@type": "Person",
        "name": "Aione",
        "image": {
            "@type": "ImageObject",
            "url": "https://aione.space/img/new/android-icon-192x192.png"
        },
        "description": "一起快乐摸鱼吧🐳"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Aione&#39;s blog",
        "logo": {
            "@type": "ImageObject",
            "url": "https://aione.space/img/new/android-icon-192x192.png"
        }
    },
    
    "potentialAction": {
        "@type": "SearchAction",
        "target": "https://aione.space/search/?s={search_term_string}",
        "query-input": "required name=search_term_string"
    },
    
    "keywords": ", database, transaction, aries",
    "description": "大概是 ARIES 论文的阅读笔记。
A..."
}
</script>



    <!-- ### Custom Head ### -->
    


</head>

    <body>
        

            

            <!-- ### Main content ### -->
            <!-- ## Header ##-->
<header>
    <h1 class="header-title text-center"><a href="/">Aione&#39;s blog</a></h1>

    <p class="text-center header-slogan">
        
            
                一起快乐摸鱼吧🐳
            
        
    </p>

    <nav class="navbar-section text-center">
    
        <a href="/" class="navbar-link">首页</a>
    
    
        <a href="/archives/" class="navbar-link">归档</a>
    
    
        <a href="/search/" class="navbar-link">搜索</a>
    
    
        <a href="/about/" class="navbar-link">About</a>
    
        <a href="/links/" class="navbar-link">Friends</a>
    
        <a href="/tags/" class="navbar-link">Tags</a>
    
    
    
</nav>
</header>

            
    <!-- ## Post ## -->
    
    


<div class="post-container">
    <div id="post-card" class="card">
        
        <div class="card-item-container">
            <div class="card-inner-cell">
                <!-- # Post Header Info # -->
                <div class="card-header">
                    
    <h1 class="card-title h3 mb-2">ARIES</h1>




<div class="post-header-info">
    <p class="post-header-info-left text-gray">
        <img class="author-thumb lazyload" data-src="/img/new/android-icon-192x192.png" src="/img/suka-lazyload.gif" alt="Aione's Avatar">
        <span>2020-05-26</span>
        
            <span class="suka-devide-dot"></span>
            <a class="category-link" href="/categories/笔记本/">笔记本</a>
        
        
            <!-- Busuanzi Post Views -->
<span id="busuanzi_container_page_pv" hidden>
    <span class="suka-devide-dot"></span>
    <span></span>
    <span id="busuanzi_value_page_pv"></span>
    <span>Views</span>
</span>
        
        
    </p>
    <div class="post-header-info-right">
        
            <div class="dropdown dropdown-right">
<a class="dropdown-toggle" tabindex="0">分享本文</a>
<ul class="menu share-menu">
    <!-- Share Weibo -->
    
    <li class="menu-item">
        <a href="http://service.weibo.com/share/share.php?appkey=&title=ARIES&url=https://aione.space/2020/05/26/aries/&pic=https://aione.space/img/new/android-icon-192x192.png&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">分享到微博</a>
    </li>
    

    <!-- Share Twitter -->
    
    <li class="menu-item">
        <a href="https://twitter.com/intent/tweet?text=ARIES&url=https://aione.space/2020/05/26/aries/&via=Aione" target="_blank" rel="external noopener noreferrer nofollow">分享到 Twitter</a>
    </li>
    

    <!-- Share Facebook -->
    
    <li class="menu-item">
        <a href="https://www.facebook.com/sharer/sharer.php?u=https://aione.space/2020/05/26/aries/" target="_blank" rel="external noopener noreferrer nofollow">分享到 Facebook</a>
    </li>
    

    <!-- Share Google+ -->
    
    <li class="menu-item">
        <a href="https://plus.google.com/share?url=https://aione.space/2020/05/26/aries/" target="_blank" rel="external noopener noreferrer nofollow">分享到 Google+</a>
    </li>
    

    <!-- Share LinkedIn -->
    
    <li class="menu-item">
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://aione.space/2020/05/26/aries/&title=Aione's blog" target="_blank" rel="external noopener noreferrer nofollow">分享到 LinkedIn</a>
    </li>
    

    <!-- Share QQ -->
    
    <li class="menu-item">
        <a href="http://connect.qq.com/widget/shareqq/index.html?site=Aione's blog&title=Aione's blog&summary=&pics=https://aione.space/img/new/android-icon-192x192.png&url=https://aione.space/2020/05/26/aries/" target="_blank" rel="external noopener noreferrer nofollow"> 分享到 QQ</a>
    </li>
    

    <!-- Share Telegram -->
    
    <li class="menu-item">
        <a href="https://t.me/share/url?url=https://aione.space/2020/05/26/aries/&text=Aione's blog" target="_blank" rel="external noopener noreferrer nofollow">分享到 Telegram</a>
    </li>
    

    <!-- QRCode -->
    
    <li class="menu-item">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIQAAACECAAAAAB0L9x7AAABjElEQVR42u3ay47CQAxE0fz/TzNbFNquciYK1ehmM2gAcxZWx48cr4DrAAECxBaIo7ne3/8IULx//n8VF0Q2Ypk0b8HOQc+fq/BdXBD5iCpIlZQV0o0LYl/EKgE/ghUJC+I3EU5iVq9B7I1obzSLg8hNzFvuoiAeR6hC9+rfW6ttEI8h7Oa1uUGpw+22rhzEI4jVoVMmkpF0bsELIh+x+uLqB7vCxvlMm5ggYhCqeXGaGqcwsoapIGIQKrAqXlSCWoUuiAiEami6m5FT4FrND4goRBdYFbLuwMxeuoCIQziDsW646hxSIPIRk2SbLt5A7Inomha1vFcDebmoBRGPcIrZ6VJ/3BCDiEFcfVjHbYhGHRiIGIQzNHMGI86iDkQ+wk22bigyGbyDyEW4CzjVJKsHgv61DQTxKOLKwn5a+ILYD+Ek5NWCuH0gCEQ0ovsBp3CdLvBB7I2oCln1wOj4KUQQWyCuDNjcxS+IbIQajquhukpga/MDIgYxKXTd5tg6uEBEIr55gQABIhrxB+09StrFGi/DAAAAAElFTkSuQmCC" alt="QRCode">
    </li>
    

</ul>
</div>
        
    </div>
</div>
                </div>
                <div class="card-body">
                    
                        
                            <div id="post-toc">
                                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ARIES-中的数据结构"><span class="post-toc-number">1.</span> <span class="post-toc-text">ARIES 中的数据结构</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Updates"><span class="post-toc-number">2.</span> <span class="post-toc-text">Updates</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Total-or-Partial-Rollbacks"><span class="post-toc-number">3.</span> <span class="post-toc-text">Total or Partial Rollbacks</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Checkpoints"><span class="post-toc-number">4.</span> <span class="post-toc-text">Checkpoints</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Analysis-Pass"><span class="post-toc-number">5.</span> <span class="post-toc-text">Analysis Pass</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Redo-Pass"><span class="post-toc-number">6.</span> <span class="post-toc-text">Redo Pass</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Undo-Pass"><span class="post-toc-number">7.</span> <span class="post-toc-text">Undo Pass</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Checkpoints-During-Restart"><span class="post-toc-number">8.</span> <span class="post-toc-text">Checkpoints During Restart</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#原文"><span class="post-toc-number">9.</span> <span class="post-toc-text">原文</span></a></li></ol>
                            </div>
                        
                    
                    <article id="post-content">
                        <p>大概是 ARIES 论文的阅读笔记。</p>
<h2 id="ARIES-中的数据结构"><a href="#ARIES-中的数据结构" class="headerlink" title="ARIES 中的数据结构"></a>ARIES 中的数据结构</h2><p>老生常谈的东西了，包含以下几样：</p>
<ul>
<li>LSN: log 的唯一标识符。</li>
<li>Type: 用来区分 log 的类型。</li>
<li>TxnID</li>
<li>PrevLsn: 同事务的上一条 log，在 undo 中可以减少我们寻找下一条需要被 undo 的log 所需的时间。</li>
<li>pageId</li>
<li>pageLSN: 可以加速 redo, 在没有 dpt 辅助的情况下，如果此时我们不存在 pageLSN，那么找到 redo start 的唯一方法就是，从 checkpoint 向后扫描 log, 根据 log 找出在 checkpoint 后未结束的事务，然后从 checkpoint 向前扫描， 找到这些事务对页发生修改的最早的 lsn。这样还有一个问题，当我们进行 redo 的时候，可能会发生重复 redo 破坏数据的一致性。</li>
<li>UndoNextLSN: 在 CLR log 中，用于指定下一条需要被 undo 的 log。</li>
<li>transcation table: 在 checkpoint 当中被用到，表中每个条目维护一个 tid, lastlsn，undoNextLsn, 用这个表我们可以找到每个事务最后一条 log 所在位置，方便进行 undo。</li>
<li>dirty page table: 脏页表，每个条目记录第一次使该页不同于硬盘上的页的 lsn。<br>该表可以让我们在恢复的时候更加方便的找到 redo start。</li>
</ul>
<h2 id="Updates"><a href="#Updates" class="headerlink" title="Updates"></a>Updates</h2><p>更新记录的基本操作如下<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">lockManager.Lock(oid)</span><br><span class="line">bufferPoll.Get(pageId)</span><br><span class="line">bufferPool.Pin(page)</span><br><span class="line">page.Xlock()</span><br><span class="line"><span class="keyword">defer</span> page.XUnlock()</span><br><span class="line"><span class="keyword">defer</span> buffPool.Unpin(page)</span><br><span class="line"></span><br><span class="line">logManager.LogUdate()</span><br><span class="line">page.doChange()</span><br><span class="line">bufferPool.setPageLSN(page)</span><br></pre></td></tr></table></figure></p>
<p>这么做是为了保证日志的顺序和对页更新的顺序一致，如果顺序不一致，在 redo 的时候不一定能保证事务的一致性，比如写入覆盖这个问题。同时，注意修改 pageLsn 一定在 page 被修改过后，这是由于，考虑如下情况<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">write update log</span><br><span class="line">chaneg page lsn</span><br><span class="line">checkpoint</span><br><span class="line">crash</span><br></pre></td></tr></table></figure></p>
<p>那么恢复的时候会认为该页的最后一条记录已经反应到磁盘上了，但实际上我们只修改了 pagelsn，具体内容对修改并没有反映到磁盘上。</p>
<p>在对记录更新对时候，有一种特殊情况：插入，由于在插入数据之前我们并不知道它的 oid, 所以无法对其进行 lock，只有在我们获取了该页的 latch 并且知道插入位置之后才能获取到 lcok，但是在这种情况下可能会产生死锁。而且这种死锁不能被 lockmanager 所探测到。</p>
<p>解决的方法如下，当我们向 lockmanager 发送一个立即返回的 condition lock 请求，此处的 condition 可以为 <code>page.freeSpace() &gt; tuple.Size() &amp;&amp; dstSlot.free()</code> 如果接受，那么按正常操作继续。如果没有，释放 latch，获取一个正常的 lock，该lock返回之后获取 latch，并检查该 slot 是否可用，如果不可用，则重复上述步骤（感觉自己理解还是有问题，原文如下）</p>
<blockquote>
<p>T o avoid waiting for a lock while holding a latch, which could lead to an undetected deadlock, the lock is requested conditionally, and if it is not granted, then the latch is released and the lock is requested unconditionally. Once the unconditionally requested lock is granted, the page is latched again, and any previously verified conditions are rechecked. This rechecking is required beacuse, after the page was unlatched, the conditions could have changed. The page_LSN, on relatching, if any changeds could have possibly occurred. If the conditions are still found to be satisfied for performing the update, it is performed as described above. Ohterwise, corrective actions are taken. If the conditionally requested lock is granted immediately, then the update can proceed as before.</p>
</blockquote>
<h2 id="Total-or-Partial-Rollbacks"><a href="#Total-or-Partial-Rollbacks" class="headerlink" title="Total or Partial Rollbacks"></a>Total or Partial Rollbacks</h2><p>基本操作如下<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">log := txnManager.UndoNextLsn(tid)</span><br><span class="line"></span><br><span class="line">lockManager.Lock(log.oid)</span><br><span class="line">bufferPoll.Get(log.pageId)</span><br><span class="line">bufferPool.Pin(log.page)</span><br><span class="line">page.Xlock()</span><br><span class="line"><span class="keyword">defer</span> page.XUnlock()</span><br><span class="line"><span class="keyword">defer</span> buffPool.Unpin(page)</span><br><span class="line"></span><br><span class="line">page.doUpdate()</span><br><span class="line">logManager.LogClr()</span><br></pre></td></tr></table></figure></p>
<p>rollback 部分比较简单，不过这里 writelog 的时间点和前面有所不同，只有在操作被 undo 之后才会写 clr log，同时 clr log 里的 undoNextLSN 非常重要，当我们 total rollback 但中途 crash 的时候，我们可以利用 txnTable 里的 lastLsn，直接找到对应下一条该重做的 log，提升了恢复速度。</p>
<p>为什么要在 undo 之后写 log，主要原因和上面差不多，如果提前写 log，就会存在虚空 undo 的情况，导致少撤销一条操作。</p>
<h2 id="Checkpoints"><a href="#Checkpoints" class="headerlink" title="Checkpoints"></a>Checkpoints</h2><p>ARIES 采取了 fuzzy checkpoint 技术，fuzzy checkpoint 也就是说，当我们进行 checkpoint 操作的时候不需要 stw，我们只是记录一些元信息，方便更快的恢复，不过这也需要和 bufferpoolmanager 进行配合，需要 bpm 定时向硬盘写入 pagebuffer，减少恢复所需的工作量。</p>
<p>fuzzy checkpoint 的基本操作如下，当系统进行 checkpoint 操作的时候，首先向日志写入 checkpoint_start, 然后写入 dirty page table, txn table，之后标注 checkpoint_end, 最后将 master-record 指向的记录改为当前 checkpoint_start 所在位置。</p>
<h2 id="Analysis-Pass"><a href="#Analysis-Pass" class="headerlink" title="Analysis Pass"></a>Analysis Pass</h2><p>这阶段的目的是完善 dpt 和 txnTable, 当我们 crash 的时候，checkpoint 之后的操作也需要进行 redo 和 undo，而这部分的信息并没有包含在 checkpoint 的两张表内，我们需要借助当前 pass 进行补全。</p>
<p>当前 pass 会产生 txnTable, dpt, redoLsn 三个数据结构，用于接下来两个 pass 的操作。 redoLsn 是在 dpt 里最小的 reclsn，如果 dpt 为空，也就是说没有修改发生，那么我们就没必要进行 redo。</p>
<p>当前 pass 如何构造 dpt, txnTable</p>
<ul>
<li>dpt: 对遇到的每条记录，如果所做修改的的页没有在 dpt 中出现，<code>dpt.append(lsn, lsn)</code></li>
<li>txnTable: 对遇到的每条记录，如果指明了某个事务结束，则从 txnTable 中移除，否则更新 txntable 的状态，即更新 txnTable 对应条目的 undoNextLsn, lastLsn, state</li>
</ul>
<h2 id="Redo-Pass"><a href="#Redo-Pass" class="headerlink" title="Redo Pass"></a>Redo Pass</h2><p>redo 只需要从 redoLsn 开始向后重做就好了，不过要检查几个要素，要被 redo 的页是否在 dpt 中，当前 lsn 是否大于等于该页的 recLsn，该页的 pageLsn 是否小于该 log 的lsn。</p>
<p>当我们 redo 的时候，有可能会从 checkpoint 前某个点开始 redo，这样就会造成部分页已经被写入了硬盘并且日后也未被修改，所以 checkpoint 的时候不在 dpt 当中，不需要被修改。</p>
<p>关于 pageLsn，如果 pageLsn 大于当前 lsn，即证明该条记录所做的操作已经落盘，不需要进行重做，而且我们的 recLsn 需要更新，更新为比 pageLsn 大一点的记录。由于 pageLsn 只在 redo 的时候需要，这么做也是可以的。</p>
<p>redo 部分可以发挥并行优势，因为我们的 redo 是面向 page 的，也就是说对于 dpt 的所有 page，我们都可以进行并行操作，只要事先/或者流水线 准备好对应 page 的 log queue，依次执行即可。</p>
<h2 id="Undo-Pass"><a href="#Undo-Pass" class="headerlink" title="Undo Pass"></a>Undo Pass</h2><p>因为之前的 redo pass, 当前要做的只是把 crash 时刻没有完成的事务撤销而已。undo 部分的操作和前面 rollback 基本一致，不同的是这里取得 undoNextLsn 是从 txnTable。</p>
<h2 id="Checkpoints-During-Restart"><a href="#Checkpoints-During-Restart" class="headerlink" title="Checkpoints During Restart"></a>Checkpoints During Restart</h2><p><strong>Analysis Pass</strong> 在完成这个 pass 之后，我们将现在的 dpt/txnTable 写入到硬盘上，这样下次恢复的时候就可以跳过 Analysis pass.</p>
<p><strong>Redo Pass</strong> 每次 bufferpool 向磁盘写入修改过后的页的时候，就更新该页的记录为当前 log 的下一条记录，由于 redo 是从前往后，所以同样保证了 wal 的性质。并且，在这种情况下，我们下次重启的时候就可以少一些 redo。其他记录 checkpoint 相关的记录保持不变。</p>
<p><strong>Undo Pass</strong> 在启动 undo pass 的时候，将 dpt 更新为现在 bufferpoll 的 dpt，很容易理解，在下次进行重启操作的时候只要由于前面两个 pass 的操作，可以减少工作量。</p>
<h2 id="原文"><a href="#原文" class="headerlink" title="原文"></a>原文</h2><p><a href="https://cs.stanford.edu/people/chrismre/cs345/rl/aries.pdf" target="_blank" rel="noopener">ARIES : A Transaction Recovery Method Supporting Fine-Granularity Locking and Partial Rollbacks Using Write-Ahead Logging</a></p>

                    </article>
                    
    <blockquote class="post-license">
        <p>
            <strong>本文作者&nbsp;:&nbsp;Aione</strong>
            <br>
            <strong>
            
                本文使用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)</a> 协议
            </strong>
            <br>
            <strong>本文链接&nbsp;:&nbsp;</strong><a href="https://aione.space/2020/05/26/aries/">https://aione.space/2020/05/26/aries/</a>
        </p>
    </blockquote>



    <blockquote id="date-expire-notification" class="post-expired-notify">本文最后更新于 <span id="date-expire-num"></span> 天前，文中所描述的信息可能已发生改变</blockquote>
    <script>
        var dateUpdate = Date.parse("2020-05-28");
        var nowDate = new Date();
        var a = nowDate.getTime();
        var b = a - dateUpdate;
        var daysUpdateExpire = Math.floor(b/(24*3600*1000));
        if (daysUpdateExpire >= 120) {
            document.getElementById('date-expire-num').innerHTML = daysUpdateExpire;
        } else {
            document.getElementById('date-expire-notification').style.display = 'none';
        }
    </script>


<p class="post-footer-info mb-0 pt-0">本文发表于&nbsp;<time datetime="2020-05-26T10:48:14.000Z" itemprop="datePublished">2020-05-26</time>

    , 最后修改于&nbsp;<time datetime="2020-05-28T12:18:55.597Z" itemprop="dateModified">2020-05-28</time>

</p>
<p class="post-footer-info mb-0 pt-2">

<span class="post-categories-list mt-2">


<a class="post-categories-list-item" href="/categories/笔记本/">笔记本</a>

</span>



<span class="post-tags-list mt-2">


<a class="post-tags-list-item" href="/tags/database/" rel="tag">#&nbsp;database</a>

<a class="post-tags-list-item" href="/tags/transaction/" rel="tag">#&nbsp;transaction</a>

<a class="post-tags-list-item" href="/tags/aries/" rel="tag">#&nbsp;aries</a>

</span>


</p>

                </div>
                
<div class="post-nav px-2 bg-gray">
<ul class="pagination">
    <!-- Prev Nav -->
    
        <li class="page-item page-prev">
            <a href="/2020/06/01/mapreduce/" rel="prev">
                <div class="page-item-title"><i class="icon icon-back" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">Google 三轮车之 MapReduce</div>
            </a>
        </li>
    

    <!-- Next Nav -->
    
        <li class="page-item page-next">
            <a href="/2020/03/16/firstfllow/" rel="next">
                <div class="page-item-title"><i class="icon icon-forward" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">为什么我们要计算 First Set/ Follow Set</div>
            </a>
        </li>
    
</ul>
</div>

                
                    <!-- # Comment # -->
                    
                
            </div>
        </div>
    </div>
</div>

            <!-- ### Footer ### -->
            <footer class="text-center">
    <!-- footer copyright -->
    <p class="footer-copyright mb-0">Copyright&nbsp;©&nbsp;<span data-year></span>
        <a class="footer-copyright-a" href="https://aione.space">Aione&#39;s blog</a>
    </p>
    <!-- footer custom text -->
    <p class="footer-text mb-0">
    
    </p>
    <!-- footer develop info -->
    <p class="footer-develop mb-0">
        
            
    <!-- Busuanzi User Views -->
    <span id="busuanzi_container_site_uv" hidden>
        <span></span>
        <span id="busuanzi_value_site_uv"></span>
        <span>Viewers</span>
        
            <span>|</span>
        
    </span>



        
        
        Powered by&nbsp;<!--
         --><a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="external nofollow noopener noreferrer">Hexo</a><span class="footer-develop-divider"></span>Theme&nbsp;-&nbsp;<!--
         --><a href="https://github.com/SukkaW/hexo-theme-suka" target="_blank" class="footer-develop-a" rel="external noopener">Suka</a>
    </p>
</footer>

        

        <!-- ### Import File ### -->
        <!-- ### Footer JS Import ### -->

<script>
window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 50
};



    /* Copyright */
    var copyrightNow = new Date().getFullYear();
    var copyrightContent = document.querySelector('span[data-year]')
    
        copyrightSince = 2018;
        if (copyrightSince === copyrightNow) {
            copyrightContent.textContent = copyrightNow
        } else {
            copyrightContent.textContent = copyrightSince + ' - ' + copyrightNow
        }
    



/* Cnosole Log */
console.log('\n %c Suka Theme (hexo-theme-suka) | © SukkaW | Verision 1.3.3 %c https://github.com/SukkaW/hexo-theme-suka \n', 'color: #fff; background: #444; padding:5px 0;', 'background: #bbb; padding:5px 0;');
</script>

<!-- vanilla-lazyload -->

    <script src="/lib/vanilla-lazyload/lazyload.min.js" async></script>



    <!-- Busuanzi -->
    
    <script src="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" async></script>


<!-- Offset -->







<!-- gallery.js -->


<!-- Comment -->


<!-- ### Custom Footer ### -->


    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>

</html>