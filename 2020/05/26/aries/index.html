<!DOCTYPE html>

<html lang="zh-Hans">
    <head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <!--
        Â© SukkaW
        GitHub: https://github.com/SukkaW/hexo-theme-suka
        Version: 1.3.3
    -->
    <script>
window.lsVersion = "1.3.3",
window.oldVersion = [
    
        
            "0.2.0","0.0.1","0.1.0","1.0.0","1.0.1","1.1.0","1.1.1","1.2.0","1.3.0","1.3.2"
        
    
]
</script>

    <!-- ### DNS Prefetch ### -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
<!-- busuanzi -->

    <link rel="dns-prefetch" href="//busuanzi.ibruce.info">


<!-- comment -->







<!-- analytics -->








    <!-- ### Preload ### -->
    
    <!-- Busuanzi -->
    
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" as="script">







    <!-- ### Meta & Title & Info ### -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge, chrome=1">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<!-- Title -->
<title>ARIES | Aione&#39;s blog</title>

<!-- favicon -->
<!-- Favicons -->

    <link rel="icon" type="image/ico" href="/img/new/favicon.ico">


    <link rel="apple-touch-icon" sizes="180x180" href="/img/new/apple-icon-180x180.png">


    <link rel="icon" type="image/png" sizes="192x192" href="/img/new/android-icon-192x192.png">


    <link rel="icon" type="image/png" sizes="32x32" href="/img/new/favicon-32x32.png">


    <link rel="icon" type="image/png" sizes="16x16" href="/img/new/favicon-16x16.png">


<!-- Android Chrome Color -->



<meta name="format-detection" content="telephone=no">

<!-- Description -->
<meta name="description" content="å¤§æ¦‚æ˜¯ ARIES è®ºæ–‡çš„é˜…è¯»ç¬”è®°ã€‚
A...">

<!-- Keywords -->
<meta name="keywords" content=", database, transaction, aries">

<!-- Disable Fucking Bloody Baidu Tranformation -->
<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

    <!-- ### Import File ### -->
    
        <!-- spectre.css -->

    <link rel="stylesheet" href="/lib/spectre/spectre.min.css">


<style>
    body {
        background-color: #f8f9fa;
    }

    a, a:visited {
        color: #0070ff;
    }

    a:active, a:focus, a:hover {
        color: #0070ff;
        opacity: .75;
    }

    #post-content a,
    #post-content a:hover,
    #post-content a:focus,
    #post-content a:visited {
        color: #005eb9;
        opacity: 1;
    }

    .post-entry .card-body a {
        color: #0070ff;
    }

    .avatar {
        background: #444;
    }

    .navbar-link,
    .navbar-link:visited,
    .timeline .timeline-item .timeline-icon.icon-lg {
        color: #0070ff;
    }

    .navbar-link:hover {
        color: #0070ff;
        opacity: .8;
    }

    #search-input .btn,
    #disqus_click_btn,
    #disqus-switch-to-direct,
    #disqus-loadmore-button {
        background: #727e96;
        border-color: #727e96;
        color: #fff;
    }

    #post-toc a.post-toc-link,
    #post-toc a.post-toc-link:visited,
    .share-menu.menu .menu-item>a {
        color: #727e96;
    }

    .share-menu.menu .menu-item>a:hover,
    .share-menu.menu .menu-item>a:focus,
    .share-menu.menu .menu-item>a:visited {
        color: #50596c;
        background: #f8f9fa;
        opacity: .85;
    }
</style>

<!-- style.css -->

    <link rel="stylesheet" href="/css/style.min.css">









    <!-- Prettify Theme -->
    
    
        <link rel="stylesheet" href="/css/highlight/github.min.css">
    



    

    <!-- ### Site Verification ### -->
    


    <!-- ### RSS ### -->
    

    <!-- ### WebApp ### -->
    <meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="Aione&#39;s blog">
<meta name="msapplication-starturl" content="https://aione.space">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Aione&#39;s blog">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Manifest Import -->

<!-- Open Search -->


    <!-- ### The Open Graph & Twitter Card Protocol ### -->
    <meta property="og:title" content="ARIES | Aione&#39;s blog">
<meta property="og:site_name" content="Aione&#39;s blog">

<meta property="og:locale" content="zh-Hans">

<meta property="og:url" content="https://aione.space/2020/05/26/aries/">
<meta property="og:image" content="https://aione.space/img/new/android-icon-192x192.png">

<meta property="og:description" content="å¤§æ¦‚æ˜¯ ARIES è®ºæ–‡çš„é˜…è¯»ç¬”è®°ã€‚
A...">

<meta name="twitter:card" content="summary">


    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2020-05-26T10:48:14.000Z">
    <meta property="article:modified_time" content="2020-05-26T10:48:14.000Z">
    <meta property="article:author" content="Aione">
    <meta property="og:article:tag" content=", database, transaction, aries"> 





    <!-- ### Analytics ### -->
    








    <!-- ### Canonical link ### -->
    <link rel="canonical" href="https://aione.space/2020/05/26/aries/">

    <!-- ### Structured Data ### -->
    



<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "url": "https://aione.space/2020/05/26/aries/",
    "@type": "BlogPosting",
    "logo": "https://aione.space/img/new/android-icon-192x192.png",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://aione.space/2020/05/26/aries/"
    },
    "headline": "ARIES | Aione&#39;s blog",
    
    "image": {
        "@type": "ImageObject",
        "url": "https://aione.space/img/new/android-icon-192x192.png"
    },
    
    "datePublished": "2020-05-26T10:48:14.000Z",
    "dateModified": "2020-05-28T12:18:55.597Z",
    "author": {
        "@type": "Person",
        "name": "Aione",
        "image": {
            "@type": "ImageObject",
            "url": "https://aione.space/img/new/android-icon-192x192.png"
        },
        "description": "ä¸€èµ·å¿«ä¹æ‘¸é±¼å§ğŸ³"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Aione&#39;s blog",
        "logo": {
            "@type": "ImageObject",
            "url": "https://aione.space/img/new/android-icon-192x192.png"
        }
    },
    
    "potentialAction": {
        "@type": "SearchAction",
        "target": "https://aione.space/search/?s={search_term_string}",
        "query-input": "required name=search_term_string"
    },
    
    "keywords": ", database, transaction, aries",
    "description": "å¤§æ¦‚æ˜¯ ARIES è®ºæ–‡çš„é˜…è¯»ç¬”è®°ã€‚
A..."
}
</script>



    <!-- ### Custom Head ### -->
    


</head>

    <body>
        

            

            <!-- ### Main content ### -->
            <!-- ## Header ##-->
<header>
    <h1 class="header-title text-center"><a href="/">Aione&#39;s blog</a></h1>

    <p class="text-center header-slogan">
        
            
                ä¸€èµ·å¿«ä¹æ‘¸é±¼å§ğŸ³
            
        
    </p>

    <nav class="navbar-section text-center">
    
        <a href="/" class="navbar-link">é¦–é¡µ</a>
    
    
        <a href="/archives/" class="navbar-link">å½’æ¡£</a>
    
    
        <a href="/search/" class="navbar-link">æœç´¢</a>
    
    
        <a href="/about/" class="navbar-link">About</a>
    
        <a href="/links/" class="navbar-link">Friends</a>
    
        <a href="/tags/" class="navbar-link">Tags</a>
    
    
    
</nav>
</header>

            
    <!-- ## Post ## -->
    
    


<div class="post-container">
    <div id="post-card" class="card">
        
        <div class="card-item-container">
            <div class="card-inner-cell">
                <!-- # Post Header Info # -->
                <div class="card-header">
                    
    <h1 class="card-title h3 mb-2">ARIES</h1>




<div class="post-header-info">
    <p class="post-header-info-left text-gray">
        <img class="author-thumb lazyload" data-src="/img/new/android-icon-192x192.png" src="/img/suka-lazyload.gif" alt="Aione's Avatar">
        <span>2020-05-26</span>
        
            <span class="suka-devide-dot"></span>
            <a class="category-link" href="/categories/ç¬”è®°æœ¬/">ç¬”è®°æœ¬</a>
        
        
            <!-- Busuanzi Post Views -->
<span id="busuanzi_container_page_pv" hidden>
    <span class="suka-devide-dot"></span>
    <span></span>
    <span id="busuanzi_value_page_pv"></span>
    <span>Views</span>
</span>
        
        
    </p>
    <div class="post-header-info-right">
        
            <div class="dropdown dropdown-right">
<a class="dropdown-toggle" tabindex="0">åˆ†äº«æœ¬æ–‡</a>
<ul class="menu share-menu">
    <!-- Share Weibo -->
    
    <li class="menu-item">
        <a href="http://service.weibo.com/share/share.php?appkey=&title=ARIES&url=https://aione.space/2020/05/26/aries/&pic=https://aione.space/img/new/android-icon-192x192.png&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">åˆ†äº«åˆ°å¾®åš</a>
    </li>
    

    <!-- Share Twitter -->
    
    <li class="menu-item">
        <a href="https://twitter.com/intent/tweet?text=ARIES&url=https://aione.space/2020/05/26/aries/&via=Aione" target="_blank" rel="external noopener noreferrer nofollow">åˆ†äº«åˆ° Twitter</a>
    </li>
    

    <!-- Share Facebook -->
    
    <li class="menu-item">
        <a href="https://www.facebook.com/sharer/sharer.php?u=https://aione.space/2020/05/26/aries/" target="_blank" rel="external noopener noreferrer nofollow">åˆ†äº«åˆ° Facebook</a>
    </li>
    

    <!-- Share Google+ -->
    
    <li class="menu-item">
        <a href="https://plus.google.com/share?url=https://aione.space/2020/05/26/aries/" target="_blank" rel="external noopener noreferrer nofollow">åˆ†äº«åˆ° Google+</a>
    </li>
    

    <!-- Share LinkedIn -->
    
    <li class="menu-item">
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://aione.space/2020/05/26/aries/&title=Aione's blog" target="_blank" rel="external noopener noreferrer nofollow">åˆ†äº«åˆ° LinkedIn</a>
    </li>
    

    <!-- Share QQ -->
    
    <li class="menu-item">
        <a href="http://connect.qq.com/widget/shareqq/index.html?site=Aione's blog&title=Aione's blog&summary=&pics=https://aione.space/img/new/android-icon-192x192.png&url=https://aione.space/2020/05/26/aries/" target="_blank" rel="external noopener noreferrer nofollow"> åˆ†äº«åˆ° QQ</a>
    </li>
    

    <!-- Share Telegram -->
    
    <li class="menu-item">
        <a href="https://t.me/share/url?url=https://aione.space/2020/05/26/aries/&text=Aione's blog" target="_blank" rel="external noopener noreferrer nofollow">åˆ†äº«åˆ° Telegram</a>
    </li>
    

    <!-- QRCode -->
    
    <li class="menu-item">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIQAAACECAAAAAB0L9x7AAABjElEQVR42u3ay47CQAxE0fz/TzNbFNquciYK1ehmM2gAcxZWx48cr4DrAAECxBaIo7ne3/8IULx//n8VF0Q2Ypk0b8HOQc+fq/BdXBD5iCpIlZQV0o0LYl/EKgE/ghUJC+I3EU5iVq9B7I1obzSLg8hNzFvuoiAeR6hC9+rfW6ttEI8h7Oa1uUGpw+22rhzEI4jVoVMmkpF0bsELIh+x+uLqB7vCxvlMm5ggYhCqeXGaGqcwsoapIGIQKrAqXlSCWoUuiAiEami6m5FT4FrND4goRBdYFbLuwMxeuoCIQziDsW646hxSIPIRk2SbLt5A7Inomha1vFcDebmoBRGPcIrZ6VJ/3BCDiEFcfVjHbYhGHRiIGIQzNHMGI86iDkQ+wk22bigyGbyDyEW4CzjVJKsHgv61DQTxKOLKwn5a+ILYD+Ek5NWCuH0gCEQ0ovsBp3CdLvBB7I2oCln1wOj4KUQQWyCuDNjcxS+IbIQajquhukpga/MDIgYxKXTd5tg6uEBEIr55gQABIhrxB+09StrFGi/DAAAAAElFTkSuQmCC" alt="QRCode">
    </li>
    

</ul>
</div>
        
    </div>
</div>
                </div>
                <div class="card-body">
                    
                        
                            <div id="post-toc">
                                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ARIES-ä¸­çš„æ•°æ®ç»“æ„"><span class="post-toc-number">1.</span> <span class="post-toc-text">ARIES ä¸­çš„æ•°æ®ç»“æ„</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Updates"><span class="post-toc-number">2.</span> <span class="post-toc-text">Updates</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Total-or-Partial-Rollbacks"><span class="post-toc-number">3.</span> <span class="post-toc-text">Total or Partial Rollbacks</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Checkpoints"><span class="post-toc-number">4.</span> <span class="post-toc-text">Checkpoints</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Analysis-Pass"><span class="post-toc-number">5.</span> <span class="post-toc-text">Analysis Pass</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Redo-Pass"><span class="post-toc-number">6.</span> <span class="post-toc-text">Redo Pass</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Undo-Pass"><span class="post-toc-number">7.</span> <span class="post-toc-text">Undo Pass</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Checkpoints-During-Restart"><span class="post-toc-number">8.</span> <span class="post-toc-text">Checkpoints During Restart</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#åŸæ–‡"><span class="post-toc-number">9.</span> <span class="post-toc-text">åŸæ–‡</span></a></li></ol>
                            </div>
                        
                    
                    <article id="post-content">
                        <p>å¤§æ¦‚æ˜¯ ARIES è®ºæ–‡çš„é˜…è¯»ç¬”è®°ã€‚</p>
<h2 id="ARIES-ä¸­çš„æ•°æ®ç»“æ„"><a href="#ARIES-ä¸­çš„æ•°æ®ç»“æ„" class="headerlink" title="ARIES ä¸­çš„æ•°æ®ç»“æ„"></a>ARIES ä¸­çš„æ•°æ®ç»“æ„</h2><p>è€ç”Ÿå¸¸è°ˆçš„ä¸œè¥¿äº†ï¼ŒåŒ…å«ä»¥ä¸‹å‡ æ ·ï¼š</p>
<ul>
<li>LSN: log çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚</li>
<li>Type: ç”¨æ¥åŒºåˆ† log çš„ç±»å‹ã€‚</li>
<li>TxnID</li>
<li>PrevLsn: åŒäº‹åŠ¡çš„ä¸Šä¸€æ¡ logï¼Œåœ¨ undo ä¸­å¯ä»¥å‡å°‘æˆ‘ä»¬å¯»æ‰¾ä¸‹ä¸€æ¡éœ€è¦è¢« undo çš„log æ‰€éœ€çš„æ—¶é—´ã€‚</li>
<li>pageId</li>
<li>pageLSN: å¯ä»¥åŠ é€Ÿ redo, åœ¨æ²¡æœ‰ dpt è¾…åŠ©çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ­¤æ—¶æˆ‘ä»¬ä¸å­˜åœ¨ pageLSNï¼Œé‚£ä¹ˆæ‰¾åˆ° redo start çš„å”¯ä¸€æ–¹æ³•å°±æ˜¯ï¼Œä» checkpoint å‘åæ‰«æ log, æ ¹æ® log æ‰¾å‡ºåœ¨ checkpoint åæœªç»“æŸçš„äº‹åŠ¡ï¼Œç„¶åä» checkpoint å‘å‰æ‰«æï¼Œ æ‰¾åˆ°è¿™äº›äº‹åŠ¡å¯¹é¡µå‘ç”Ÿä¿®æ”¹çš„æœ€æ—©çš„ lsnã€‚è¿™æ ·è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå½“æˆ‘ä»¬è¿›è¡Œ redo çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‘ç”Ÿé‡å¤ redo ç ´åæ•°æ®çš„ä¸€è‡´æ€§ã€‚</li>
<li>UndoNextLSN: åœ¨ CLR log ä¸­ï¼Œç”¨äºæŒ‡å®šä¸‹ä¸€æ¡éœ€è¦è¢« undo çš„ logã€‚</li>
<li>transcation table: åœ¨ checkpoint å½“ä¸­è¢«ç”¨åˆ°ï¼Œè¡¨ä¸­æ¯ä¸ªæ¡ç›®ç»´æŠ¤ä¸€ä¸ª tid, lastlsnï¼ŒundoNextLsn, ç”¨è¿™ä¸ªè¡¨æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°æ¯ä¸ªäº‹åŠ¡æœ€åä¸€æ¡ log æ‰€åœ¨ä½ç½®ï¼Œæ–¹ä¾¿è¿›è¡Œ undoã€‚</li>
<li>dirty page table: è„é¡µè¡¨ï¼Œæ¯ä¸ªæ¡ç›®è®°å½•ç¬¬ä¸€æ¬¡ä½¿è¯¥é¡µä¸åŒäºç¡¬ç›˜ä¸Šçš„é¡µçš„ lsnã€‚<br>è¯¥è¡¨å¯ä»¥è®©æˆ‘ä»¬åœ¨æ¢å¤çš„æ—¶å€™æ›´åŠ æ–¹ä¾¿çš„æ‰¾åˆ° redo startã€‚</li>
</ul>
<h2 id="Updates"><a href="#Updates" class="headerlink" title="Updates"></a>Updates</h2><p>æ›´æ–°è®°å½•çš„åŸºæœ¬æ“ä½œå¦‚ä¸‹<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">lockManager.Lock(oid)</span><br><span class="line">bufferPoll.Get(pageId)</span><br><span class="line">bufferPool.Pin(page)</span><br><span class="line">page.Xlock()</span><br><span class="line"><span class="keyword">defer</span> page.XUnlock()</span><br><span class="line"><span class="keyword">defer</span> buffPool.Unpin(page)</span><br><span class="line"></span><br><span class="line">logManager.LogUdate()</span><br><span class="line">page.doChange()</span><br><span class="line">bufferPool.setPageLSN(page)</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¹ˆåšæ˜¯ä¸ºäº†ä¿è¯æ—¥å¿—çš„é¡ºåºå’Œå¯¹é¡µæ›´æ–°çš„é¡ºåºä¸€è‡´ï¼Œå¦‚æœé¡ºåºä¸ä¸€è‡´ï¼Œåœ¨ redo çš„æ—¶å€™ä¸ä¸€å®šèƒ½ä¿è¯äº‹åŠ¡çš„ä¸€è‡´æ€§ï¼Œæ¯”å¦‚å†™å…¥è¦†ç›–è¿™ä¸ªé—®é¢˜ã€‚åŒæ—¶ï¼Œæ³¨æ„ä¿®æ”¹ pageLsn ä¸€å®šåœ¨ page è¢«ä¿®æ”¹è¿‡åï¼Œè¿™æ˜¯ç”±äºï¼Œè€ƒè™‘å¦‚ä¸‹æƒ…å†µ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">write update log</span><br><span class="line">chaneg page lsn</span><br><span class="line">checkpoint</span><br><span class="line">crash</span><br></pre></td></tr></table></figure></p>
<p>é‚£ä¹ˆæ¢å¤çš„æ—¶å€™ä¼šè®¤ä¸ºè¯¥é¡µçš„æœ€åä¸€æ¡è®°å½•å·²ç»ååº”åˆ°ç£ç›˜ä¸Šäº†ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬åªä¿®æ”¹äº† pagelsnï¼Œå…·ä½“å†…å®¹å¯¹ä¿®æ”¹å¹¶æ²¡æœ‰åæ˜ åˆ°ç£ç›˜ä¸Šã€‚</p>
<p>åœ¨å¯¹è®°å½•æ›´æ–°å¯¹æ—¶å€™ï¼Œæœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼šæ’å…¥ï¼Œç”±äºåœ¨æ’å…¥æ•°æ®ä¹‹å‰æˆ‘ä»¬å¹¶ä¸çŸ¥é“å®ƒçš„ oid, æ‰€ä»¥æ— æ³•å¯¹å…¶è¿›è¡Œ lockï¼Œåªæœ‰åœ¨æˆ‘ä»¬è·å–äº†è¯¥é¡µçš„ latch å¹¶ä¸”çŸ¥é“æ’å…¥ä½ç½®ä¹‹åæ‰èƒ½è·å–åˆ° lcokï¼Œä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹å¯èƒ½ä¼šäº§ç”Ÿæ­»é”ã€‚è€Œä¸”è¿™ç§æ­»é”ä¸èƒ½è¢« lockmanager æ‰€æ¢æµ‹åˆ°ã€‚</p>
<p>è§£å†³çš„æ–¹æ³•å¦‚ä¸‹ï¼Œå½“æˆ‘ä»¬å‘ lockmanager å‘é€ä¸€ä¸ªç«‹å³è¿”å›çš„ condition lock è¯·æ±‚ï¼Œæ­¤å¤„çš„ condition å¯ä»¥ä¸º <code>page.freeSpace() &gt; tuple.Size() &amp;&amp; dstSlot.free()</code> å¦‚æœæ¥å—ï¼Œé‚£ä¹ˆæŒ‰æ­£å¸¸æ“ä½œç»§ç»­ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾ latchï¼Œè·å–ä¸€ä¸ªæ­£å¸¸çš„ lockï¼Œè¯¥lockè¿”å›ä¹‹åè·å– latchï¼Œå¹¶æ£€æŸ¥è¯¥ slot æ˜¯å¦å¯ç”¨ï¼Œå¦‚æœä¸å¯ç”¨ï¼Œåˆ™é‡å¤ä¸Šè¿°æ­¥éª¤ï¼ˆæ„Ÿè§‰è‡ªå·±ç†è§£è¿˜æ˜¯æœ‰é—®é¢˜ï¼ŒåŸæ–‡å¦‚ä¸‹ï¼‰</p>
<blockquote>
<p>T o avoid waiting for a lock while holding a latch, which could lead to an undetected deadlock, the lock is requested conditionally, and if it is not granted, then the latch is released and the lock is requested unconditionally. Once the unconditionally requested lock is granted, the page is latched again, and any previously verified conditions are rechecked. This rechecking is required beacuse, after the page was unlatched, the conditions could have changed. The page_LSN, on relatching, if any changeds could have possibly occurred. If the conditions are still found to be satisfied for performing the update, it is performed as described above. Ohterwise, corrective actions are taken. If the conditionally requested lock is granted immediately, then the update can proceed as before.</p>
</blockquote>
<h2 id="Total-or-Partial-Rollbacks"><a href="#Total-or-Partial-Rollbacks" class="headerlink" title="Total or Partial Rollbacks"></a>Total or Partial Rollbacks</h2><p>åŸºæœ¬æ“ä½œå¦‚ä¸‹<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">log := txnManager.UndoNextLsn(tid)</span><br><span class="line"></span><br><span class="line">lockManager.Lock(log.oid)</span><br><span class="line">bufferPoll.Get(log.pageId)</span><br><span class="line">bufferPool.Pin(log.page)</span><br><span class="line">page.Xlock()</span><br><span class="line"><span class="keyword">defer</span> page.XUnlock()</span><br><span class="line"><span class="keyword">defer</span> buffPool.Unpin(page)</span><br><span class="line"></span><br><span class="line">page.doUpdate()</span><br><span class="line">logManager.LogClr()</span><br></pre></td></tr></table></figure></p>
<p>rollback éƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œä¸è¿‡è¿™é‡Œ writelog çš„æ—¶é—´ç‚¹å’Œå‰é¢æœ‰æ‰€ä¸åŒï¼Œåªæœ‰åœ¨æ“ä½œè¢« undo ä¹‹åæ‰ä¼šå†™ clr logï¼ŒåŒæ—¶ clr log é‡Œçš„ undoNextLSN éå¸¸é‡è¦ï¼Œå½“æˆ‘ä»¬ total rollback ä½†ä¸­é€” crash çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ txnTable é‡Œçš„ lastLsnï¼Œç›´æ¥æ‰¾åˆ°å¯¹åº”ä¸‹ä¸€æ¡è¯¥é‡åšçš„ logï¼Œæå‡äº†æ¢å¤é€Ÿåº¦ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦åœ¨ undo ä¹‹åå†™ logï¼Œä¸»è¦åŸå› å’Œä¸Šé¢å·®ä¸å¤šï¼Œå¦‚æœæå‰å†™ logï¼Œå°±ä¼šå­˜åœ¨è™šç©º undo çš„æƒ…å†µï¼Œå¯¼è‡´å°‘æ’¤é”€ä¸€æ¡æ“ä½œã€‚</p>
<h2 id="Checkpoints"><a href="#Checkpoints" class="headerlink" title="Checkpoints"></a>Checkpoints</h2><p>ARIES é‡‡å–äº† fuzzy checkpoint æŠ€æœ¯ï¼Œfuzzy checkpoint ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬è¿›è¡Œ checkpoint æ“ä½œçš„æ—¶å€™ä¸éœ€è¦ stwï¼Œæˆ‘ä»¬åªæ˜¯è®°å½•ä¸€äº›å…ƒä¿¡æ¯ï¼Œæ–¹ä¾¿æ›´å¿«çš„æ¢å¤ï¼Œä¸è¿‡è¿™ä¹Ÿéœ€è¦å’Œ bufferpoolmanager è¿›è¡Œé…åˆï¼Œéœ€è¦ bpm å®šæ—¶å‘ç¡¬ç›˜å†™å…¥ pagebufferï¼Œå‡å°‘æ¢å¤æ‰€éœ€çš„å·¥ä½œé‡ã€‚</p>
<p>fuzzy checkpoint çš„åŸºæœ¬æ“ä½œå¦‚ä¸‹ï¼Œå½“ç³»ç»Ÿè¿›è¡Œ checkpoint æ“ä½œçš„æ—¶å€™ï¼Œé¦–å…ˆå‘æ—¥å¿—å†™å…¥ checkpoint_start, ç„¶åå†™å…¥ dirty page table, txn tableï¼Œä¹‹åæ ‡æ³¨ checkpoint_end, æœ€åå°† master-record æŒ‡å‘çš„è®°å½•æ”¹ä¸ºå½“å‰ checkpoint_start æ‰€åœ¨ä½ç½®ã€‚</p>
<h2 id="Analysis-Pass"><a href="#Analysis-Pass" class="headerlink" title="Analysis Pass"></a>Analysis Pass</h2><p>è¿™é˜¶æ®µçš„ç›®çš„æ˜¯å®Œå–„ dpt å’Œ txnTable, å½“æˆ‘ä»¬ crash çš„æ—¶å€™ï¼Œcheckpoint ä¹‹åçš„æ“ä½œä¹Ÿéœ€è¦è¿›è¡Œ redo å’Œ undoï¼Œè€Œè¿™éƒ¨åˆ†çš„ä¿¡æ¯å¹¶æ²¡æœ‰åŒ…å«åœ¨ checkpoint çš„ä¸¤å¼ è¡¨å†…ï¼Œæˆ‘ä»¬éœ€è¦å€ŸåŠ©å½“å‰ pass è¿›è¡Œè¡¥å…¨ã€‚</p>
<p>å½“å‰ pass ä¼šäº§ç”Ÿ txnTable, dpt, redoLsn ä¸‰ä¸ªæ•°æ®ç»“æ„ï¼Œç”¨äºæ¥ä¸‹æ¥ä¸¤ä¸ª pass çš„æ“ä½œã€‚ redoLsn æ˜¯åœ¨ dpt é‡Œæœ€å°çš„ reclsnï¼Œå¦‚æœ dpt ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰ä¿®æ”¹å‘ç”Ÿï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ²¡å¿…è¦è¿›è¡Œ redoã€‚</p>
<p>å½“å‰ pass å¦‚ä½•æ„é€  dpt, txnTable</p>
<ul>
<li>dpt: å¯¹é‡åˆ°çš„æ¯æ¡è®°å½•ï¼Œå¦‚æœæ‰€åšä¿®æ”¹çš„çš„é¡µæ²¡æœ‰åœ¨ dpt ä¸­å‡ºç°ï¼Œ<code>dpt.append(lsn, lsn)</code></li>
<li>txnTable: å¯¹é‡åˆ°çš„æ¯æ¡è®°å½•ï¼Œå¦‚æœæŒ‡æ˜äº†æŸä¸ªäº‹åŠ¡ç»“æŸï¼Œåˆ™ä» txnTable ä¸­ç§»é™¤ï¼Œå¦åˆ™æ›´æ–° txntable çš„çŠ¶æ€ï¼Œå³æ›´æ–° txnTable å¯¹åº”æ¡ç›®çš„ undoNextLsn, lastLsn, state</li>
</ul>
<h2 id="Redo-Pass"><a href="#Redo-Pass" class="headerlink" title="Redo Pass"></a>Redo Pass</h2><p>redo åªéœ€è¦ä» redoLsn å¼€å§‹å‘åé‡åšå°±å¥½äº†ï¼Œä¸è¿‡è¦æ£€æŸ¥å‡ ä¸ªè¦ç´ ï¼Œè¦è¢« redo çš„é¡µæ˜¯å¦åœ¨ dpt ä¸­ï¼Œå½“å‰ lsn æ˜¯å¦å¤§äºç­‰äºè¯¥é¡µçš„ recLsnï¼Œè¯¥é¡µçš„ pageLsn æ˜¯å¦å°äºè¯¥ log çš„lsnã€‚</p>
<p>å½“æˆ‘ä»¬ redo çš„æ—¶å€™ï¼Œæœ‰å¯èƒ½ä¼šä» checkpoint å‰æŸä¸ªç‚¹å¼€å§‹ redoï¼Œè¿™æ ·å°±ä¼šé€ æˆéƒ¨åˆ†é¡µå·²ç»è¢«å†™å…¥äº†ç¡¬ç›˜å¹¶ä¸”æ—¥åä¹Ÿæœªè¢«ä¿®æ”¹ï¼Œæ‰€ä»¥ checkpoint çš„æ—¶å€™ä¸åœ¨ dpt å½“ä¸­ï¼Œä¸éœ€è¦è¢«ä¿®æ”¹ã€‚</p>
<p>å…³äº pageLsnï¼Œå¦‚æœ pageLsn å¤§äºå½“å‰ lsnï¼Œå³è¯æ˜è¯¥æ¡è®°å½•æ‰€åšçš„æ“ä½œå·²ç»è½ç›˜ï¼Œä¸éœ€è¦è¿›è¡Œé‡åšï¼Œè€Œä¸”æˆ‘ä»¬çš„ recLsn éœ€è¦æ›´æ–°ï¼Œæ›´æ–°ä¸ºæ¯” pageLsn å¤§ä¸€ç‚¹çš„è®°å½•ã€‚ç”±äº pageLsn åªåœ¨ redo çš„æ—¶å€™éœ€è¦ï¼Œè¿™ä¹ˆåšä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<p>redo éƒ¨åˆ†å¯ä»¥å‘æŒ¥å¹¶è¡Œä¼˜åŠ¿ï¼Œå› ä¸ºæˆ‘ä»¬çš„ redo æ˜¯é¢å‘ page çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹äº dpt çš„æ‰€æœ‰ pageï¼Œæˆ‘ä»¬éƒ½å¯ä»¥è¿›è¡Œå¹¶è¡Œæ“ä½œï¼Œåªè¦äº‹å…ˆ/æˆ–è€…æµæ°´çº¿ å‡†å¤‡å¥½å¯¹åº” page çš„ log queueï¼Œä¾æ¬¡æ‰§è¡Œå³å¯ã€‚</p>
<h2 id="Undo-Pass"><a href="#Undo-Pass" class="headerlink" title="Undo Pass"></a>Undo Pass</h2><p>å› ä¸ºä¹‹å‰çš„ redo pass, å½“å‰è¦åšçš„åªæ˜¯æŠŠ crash æ—¶åˆ»æ²¡æœ‰å®Œæˆçš„äº‹åŠ¡æ’¤é”€è€Œå·²ã€‚undo éƒ¨åˆ†çš„æ“ä½œå’Œå‰é¢ rollback åŸºæœ¬ä¸€è‡´ï¼Œä¸åŒçš„æ˜¯è¿™é‡Œå–å¾— undoNextLsn æ˜¯ä» txnTableã€‚</p>
<h2 id="Checkpoints-During-Restart"><a href="#Checkpoints-During-Restart" class="headerlink" title="Checkpoints During Restart"></a>Checkpoints During Restart</h2><p><strong>Analysis Pass</strong> åœ¨å®Œæˆè¿™ä¸ª pass ä¹‹åï¼Œæˆ‘ä»¬å°†ç°åœ¨çš„ dpt/txnTable å†™å…¥åˆ°ç¡¬ç›˜ä¸Šï¼Œè¿™æ ·ä¸‹æ¬¡æ¢å¤çš„æ—¶å€™å°±å¯ä»¥è·³è¿‡ Analysis pass.</p>
<p><strong>Redo Pass</strong> æ¯æ¬¡ bufferpool å‘ç£ç›˜å†™å…¥ä¿®æ”¹è¿‡åçš„é¡µçš„æ—¶å€™ï¼Œå°±æ›´æ–°è¯¥é¡µçš„è®°å½•ä¸ºå½“å‰ log çš„ä¸‹ä¸€æ¡è®°å½•ï¼Œç”±äº redo æ˜¯ä»å‰å¾€åï¼Œæ‰€ä»¥åŒæ ·ä¿è¯äº† wal çš„æ€§è´¨ã€‚å¹¶ä¸”ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸‹æ¬¡é‡å¯çš„æ—¶å€™å°±å¯ä»¥å°‘ä¸€äº› redoã€‚å…¶ä»–è®°å½• checkpoint ç›¸å…³çš„è®°å½•ä¿æŒä¸å˜ã€‚</p>
<p><strong>Undo Pass</strong> åœ¨å¯åŠ¨ undo pass çš„æ—¶å€™ï¼Œå°† dpt æ›´æ–°ä¸ºç°åœ¨ bufferpoll çš„ dptï¼Œå¾ˆå®¹æ˜“ç†è§£ï¼Œåœ¨ä¸‹æ¬¡è¿›è¡Œé‡å¯æ“ä½œçš„æ—¶å€™åªè¦ç”±äºå‰é¢ä¸¤ä¸ª pass çš„æ“ä½œï¼Œå¯ä»¥å‡å°‘å·¥ä½œé‡ã€‚</p>
<h2 id="åŸæ–‡"><a href="#åŸæ–‡" class="headerlink" title="åŸæ–‡"></a>åŸæ–‡</h2><p><a href="https://cs.stanford.edu/people/chrismre/cs345/rl/aries.pdf" target="_blank" rel="noopener">ARIES : A Transaction Recovery Method Supporting Fine-Granularity Locking and Partial Rollbacks Using Write-Ahead Logging</a></p>

                    </article>
                    
    <blockquote class="post-license">
        <p>
            <strong>æœ¬æ–‡ä½œè€…&nbsp;:&nbsp;Aione</strong>
            <br>
            <strong>
            
                æœ¬æ–‡ä½¿ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™… (CC BY-NC-SA 4.0)</a> åè®®
            </strong>
            <br>
            <strong>æœ¬æ–‡é“¾æ¥&nbsp;:&nbsp;</strong><a href="https://aione.space/2020/05/26/aries/">https://aione.space/2020/05/26/aries/</a>
        </p>
    </blockquote>



    <blockquote id="date-expire-notification" class="post-expired-notify">æœ¬æ–‡æœ€åæ›´æ–°äº <span id="date-expire-num"></span> å¤©å‰ï¼Œæ–‡ä¸­æ‰€æè¿°çš„ä¿¡æ¯å¯èƒ½å·²å‘ç”Ÿæ”¹å˜</blockquote>
    <script>
        var dateUpdate = Date.parse("2020-05-28");
        var nowDate = new Date();
        var a = nowDate.getTime();
        var b = a - dateUpdate;
        var daysUpdateExpire = Math.floor(b/(24*3600*1000));
        if (daysUpdateExpire >= 120) {
            document.getElementById('date-expire-num').innerHTML = daysUpdateExpire;
        } else {
            document.getElementById('date-expire-notification').style.display = 'none';
        }
    </script>


<p class="post-footer-info mb-0 pt-0">æœ¬æ–‡å‘è¡¨äº&nbsp;<time datetime="2020-05-26T10:48:14.000Z" itemprop="datePublished">2020-05-26</time>

    , æœ€åä¿®æ”¹äº&nbsp;<time datetime="2020-05-28T12:18:55.597Z" itemprop="dateModified">2020-05-28</time>

</p>
<p class="post-footer-info mb-0 pt-2">

<span class="post-categories-list mt-2">


<a class="post-categories-list-item" href="/categories/ç¬”è®°æœ¬/">ç¬”è®°æœ¬</a>

</span>



<span class="post-tags-list mt-2">


<a class="post-tags-list-item" href="/tags/database/" rel="tag">#&nbsp;database</a>

<a class="post-tags-list-item" href="/tags/transaction/" rel="tag">#&nbsp;transaction</a>

<a class="post-tags-list-item" href="/tags/aries/" rel="tag">#&nbsp;aries</a>

</span>


</p>

                </div>
                
<div class="post-nav px-2 bg-gray">
<ul class="pagination">
    <!-- Prev Nav -->
    
        <li class="page-item page-prev">
            <a href="/2020/06/01/mapreduce/" rel="prev">
                <div class="page-item-title"><i class="icon icon-back" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">Google ä¸‰è½®è½¦ä¹‹ MapReduce</div>
            </a>
        </li>
    

    <!-- Next Nav -->
    
        <li class="page-item page-next">
            <a href="/2020/03/16/firstfllow/" rel="next">
                <div class="page-item-title"><i class="icon icon-forward" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦è®¡ç®— First Set/ Follow Set</div>
            </a>
        </li>
    
</ul>
</div>

                
                    <!-- # Comment # -->
                    
                
            </div>
        </div>
    </div>
</div>

            <!-- ### Footer ### -->
            <footer class="text-center">
    <!-- footer copyright -->
    <p class="footer-copyright mb-0">Copyright&nbsp;Â©&nbsp;<span data-year></span>
        <a class="footer-copyright-a" href="https://aione.space">Aione&#39;s blog</a>
    </p>
    <!-- footer custom text -->
    <p class="footer-text mb-0">
    
    </p>
    <!-- footer develop info -->
    <p class="footer-develop mb-0">
        
            
    <!-- Busuanzi User Views -->
    <span id="busuanzi_container_site_uv" hidden>
        <span></span>
        <span id="busuanzi_value_site_uv"></span>
        <span>Viewers</span>
        
            <span>|</span>
        
    </span>



        
        
        Powered by&nbsp;<!--
         --><a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="external nofollow noopener noreferrer">Hexo</a><span class="footer-develop-divider"></span>Theme&nbsp;-&nbsp;<!--
         --><a href="https://github.com/SukkaW/hexo-theme-suka" target="_blank" class="footer-develop-a" rel="external noopener">Suka</a>
    </p>
</footer>

        

        <!-- ### Import File ### -->
        <!-- ### Footer JS Import ### -->

<script>
window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 50
};



    /* Copyright */
    var copyrightNow = new Date().getFullYear();
    var copyrightContent = document.querySelector('span[data-year]')
    
        copyrightSince = 2018;
        if (copyrightSince === copyrightNow) {
            copyrightContent.textContent = copyrightNow
        } else {
            copyrightContent.textContent = copyrightSince + ' - ' + copyrightNow
        }
    



/* Cnosole Log */
console.log('\n %c Suka Theme (hexo-theme-suka) | Â© SukkaW | Verision 1.3.3 %c https://github.com/SukkaW/hexo-theme-suka \n', 'color: #fff; background: #444; padding:5px 0;', 'background: #bbb; padding:5px 0;');
</script>

<!-- vanilla-lazyload -->

    <script src="/lib/vanilla-lazyload/lazyload.min.js" async></script>



    <!-- Busuanzi -->
    
    <script src="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" async></script>


<!-- Offset -->







<!-- gallery.js -->


<!-- Comment -->


<!-- ### Custom Footer ### -->


    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>

</html>